<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./css/index.css">    
</head>
<body>
    <div class="page-wrapper">
        <div class="distracted">
            <h1>Im so distracted</h1>        
        </div>

        <div class="container">
            <h1>This is what im going to do <br> RIGHT NOW</h1>

            <form id="top-form">
                <input id="top-input" type="text" name="" id="">
                <button type="submit">Submit</button>
            </form>
        </div>

        <div class="concurrent">
            <h1>Im so concurrent</h1>
        </div>
    </div>

    <script>
        let boxCount = 0;

        // Function to create a task box with delete button
        function createTaskBox(taskTitle, taskId) {
            const newBox = document.createElement('div');
            const boxId = `box-${boxCount}`;
            newBox.setAttribute('id', boxId);
            newBox.className = `box box-${(boxCount % 5) + 1}`;
            newBox.dataset.taskId = taskId || ''; // Store the task ID for delete operation
            
            // Create task text element
            const taskText = document.createElement('p');
            taskText.textContent = taskTitle;
            newBox.appendChild(taskText);
            
            // Create delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = '&times;'; // Ã— symbol
            deleteBtn.addEventListener('click', function() {
                // Delete from backend if we have a task ID
                if (taskId) {
                    fetch(`/api/tasks/${taskId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            console.log(`Task with ID ${taskId} deleted`);
                        } else {
                            console.error('Failed to delete task');
                            return;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        return;
                    });
                }
                
                // Find elements to remove
                const boxToRemove = document.getElementById(boxId);
                let vlToRemove = boxToRemove.previousElementSibling;
                let arrowToRemove = boxToRemove.previousElementSibling?.previousElementSibling;
                
                // If this is not the first box, remove the connecting elements
                if (vlToRemove && vlToRemove.className === 'arrow-down') {
                    arrowToRemove = vlToRemove;
                    vlToRemove = arrowToRemove.previousElementSibling;
                }
                
                // Remove elements from DOM
                if (vlToRemove && vlToRemove.className === 'vl') {
                    vlToRemove.remove();
                }
                if (arrowToRemove && arrowToRemove.className === 'arrow-down') {
                    arrowToRemove.remove();
                }
                boxToRemove.remove();
            });
            
            newBox.appendChild(deleteBtn);
            return newBox;
        }

        fetch('/api/tasks', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            console.log('Success:', data);
            data.forEach(task => {
                boxCount++;
                
                // Create vertical line and arrow (for all tasks except the first one)
                if (boxCount > 1) {
                    const vl = document.createElement('div');
                    vl.className = 'vl';
                    const arrowDown = document.createElement('div');
                    arrowDown.className = 'arrow-down';
                    
                    const container = document.querySelector('.container');
                    container.appendChild(vl);
                    container.appendChild(arrowDown);
                }
                
                // Create the task box with delete button
                const newBox = createTaskBox(task.title, task._id);
                
                const container = document.querySelector('.container');
                container.appendChild(newBox);
            });
        });

        const topInput = document.getElementById('top-input');
        const topForm = document.getElementById('top-form');
        topForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if(!topInput.value.trim()) return;
            
            boxCount++;
            
            // Create vertical line and arrow
            const vl = document.createElement('div');
            vl.className = 'vl';
            const arrowDown = document.createElement('div');
            arrowDown.className = 'arrow-down';

            // Get references
            const container = document.querySelector('.container');
            
            fetch('/api/tasks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: topInput.value,
                    description: 'Description',
                    completed: false,
                }),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                
                // Add elements to DOM
                container.appendChild(vl);
                container.appendChild(arrowDown);
                
                // Create task box with the returned task ID
                const newBox = createTaskBox(topInput.value, data._id);
                container.appendChild(newBox);
                
                // Clear the input field
                topInput.value = '';
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        });
    </script>
</body>
</html>
